<!DOCTYPE html>
<html>
  <head>
  <title>Retrieving Autocomplete Predictions</title>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #right-panel {
        font-family: 'Roboto','sans-serif';
        line-height: 30px;
        padding-left: 10px;
      }

      #right-panel select, #right-panel input {
        font-size: 15px;
      }

      #right-panel select {
        width: 100%;
      }

      #right-panel i {
        font-size: 12px;
      }
      #map {
        width: 100%;
        max-width:500px;
        height:300px;
      }
    </style>
  </head>
  <body>
    <p>Please search and select the address from the list below</p>
    <div id="right-panel">
      <form id="pre-form">
        <input id="pre-input" type="text" placeholder="Search your address"></input>
        <button id="pre-submit" type="submit" value="submit">Search</button>
      </form>
      <p id="pre-input-text"></p>
      <form id="results"></form>
      <p id="myaddress"></p>
      <div id="map"></div>
      <p id="new-address"></p>
    </div>
    <script>
     
      // Input value search
      function getPreValue() {
        document.getElementById('pre-submit').addEventListener('click', function(event) {
          event.preventDefault();
          var preInputValue = document.getElementById('pre-input').value;
          initService(preInputValue);
          myAddress();
        });
      }

      // Retrieves autocomplete predictions programmatically from the Google search
      function initService(inputValue) {
        document.getElementById('results').innerHTML = ''; //remove previous results
        var displaySuggestions = function(predictions, status) {
          if (status != google.maps.places.PlacesServiceStatus.OK) {
            alert('Sorry we can not find your address on Google data, please put more information about your address or put the address near by.');
            return;
          }
          // List all options in to radio
          predictions.forEach(function(prediction) {
            var inputRadio = '<input type="radio" name="address" value="' + prediction.description + '">' + prediction.description + '<br>';
            var mainForm = document.getElementById('results'),
                makeDiv = document.createElement('div');
                makeDiv.innerHTML = inputRadio;
                mainForm.appendChild(makeDiv);
                //console.log(prediction.terms);
          });
        };
        var service = new google.maps.places.AutocompleteService();
        service.getQueryPredictions({ input: inputValue }, displaySuggestions);
      };

      // Get value from radio button
      var myAddressValue = '';
      function myAddress(){
        var addressList = document.getElementById('results');
        addressList.addEventListener('click', function(e) {
          if (e.target.tagName === 'INPUT'){
            myAddressValue = e.target.value;
            document.getElementById('myaddress').innerHTML = myAddressValue;
            initMap();
          }
        });
      }

      // Create Google map
      function initMap() {
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 15,
          center: {lat: 50.0755, lng: 14.4378}
        });
        var geocoder = new google.maps.Geocoder();
         geocodeAddress(geocoder, map);
      }

      // Change address to lat and long
      function geocodeAddress(geocoder, resultsMap) {
       var address = myAddressValue;
        geocoder.geocode({'address': address}, function(results, status) {
          if (status === 'OK') {
            resultsMap.setCenter(results[0].geometry.location);
            var marker = new google.maps.Marker({
              map: resultsMap,
              draggable: true,
              animation: google.maps.Animation.DROP,
              position: results[0].geometry.location
            });
            console.log(results[0].formatted_address);

            google.maps.event.addListener(marker, 'dragend', function (event) {
              var positionLat = this.getPosition().lat();
              var positionLong = this.getPosition().lng();
              var latlng = {lat: positionLat, lng: positionLong}
              console.log(latlng);
              geocoder.geocode({'location': latlng}, function(results, status) {
                if (status === 'OK') {
                  console.log('New address: ' + results[0].formatted_address);
                } else {
                  console.log('Geocoder failed due to: ' + status);
                }
              });
            });

          } else {
            console.log('Geocode was not successful for the following reason: ' + status);
          }
        });
      }
      function initAll(){
      initMap();
      getPreValue();
 }
    </script>
   <!--<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD2UzyELYk2dzGoyJGvCSrueFq3gOPEr3I&libraries=places&callback=initService"
        async defer></script>-->
     <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD2UzyELYk2dzGoyJGvCSrueFq3gOPEr3I&libraries=places&callback=initAll"
        async defer></script>

  </body>
</html>